#!/usr/bin/env bash
set -euo pipefail

# Block commits with profiles.user_id pattern
if git diff --cached -U0 | grep -E "\+.*profiles.*\.eq\(['\"]user_id['\"]" -q; then
  echo "‚ùå Commit blocked: Use .eq('id', ...) for 'profiles' table, not 'user_id'."
  exit 1
fi

# Block accidental src_overview usage (use 'overview' instead)
if git diff --cached -U0 | grep -E "\+.*\.from\(['\"]src_overview['\"]\)" -q; then
  echo "‚ùå Commit blocked: Use 'overview' instead of 'src_overview'."
  exit 1
fi

# Block new LanguageSwitcher outside AppLayout
if git diff --cached -U0 | grep -E "\+.*<LanguageSwitcher\s*/?>" -q; then
  echo "‚ùå Commit blocked: LanguageSwitcher only allowed in AppLayout."
  exit 1
fi

# Block accidental secrets/keys in commits
if git diff --cached -U0 | grep -iE "\+(.*)(SUPABASE_.*(service|role)|PG_CONNECTION|postgresql://[^@]+@|apikey|Bearer [A-Za-z0-9_-]{20,})" -q; then
  echo "‚ùå Commit blocked: Possible API key or secret detected. Use GitHub Secrets instead."
  exit 1
fi

# Block flat dotted keys in i18n locale JSON files
if git diff --cached --name-only | grep -E '^public/locales/.+\.json$' -q; then
  if git diff --cached | grep -E "\+\s*\"[a-zA-Z0-9_]+\.[a-zA-Z0-9_.]+\"\s*:\s*\"" -q; then
    echo "‚ùå Commit blocked: Flat dotted keys detected in locale JSON. Use nested objects."
    echo "   Example: Use { \"sectors\": { \"it\": \"IT\" } } instead of { \"sectors.it\": \"IT\" }"
    exit 1
  fi
fi

# Run i18n validation
node scripts/check-i18n.js || exit 1

# --- CORS self-test (optional, env-gesteuert) ---
if [ "${GIT_CORS_CHECK:-}" = "1" ] || { [ -n "${SUPABASE_URL:-}" ] && [ -n "${SUPABASE_ANON_KEY:-}" ] && [ -n "${TEST_ORIGIN:-}" ]; }; then
  echo "üîé Running CORS self-test for verify-master ..."
  if timeout 20 node scripts/cors-selftest.mjs >/dev/null 2>&1; then
    echo "‚úÖ CORS self-test passed."
  else
    echo "‚ùå CORS self-test failed. Set ALLOWED_ORIGINS correctly or export SUPABASE_URL/SUPABASE_ANON_KEY/TEST_ORIGIN."
    echo "   Tip: to bypass temporarily, unset GIT_CORS_CHECK or remove env vars."
    exit 1
  fi
else
  echo "‚ÑπÔ∏è  CORS self-test skipped (missing env or GIT_CORS_CHECK not set)."
fi
